version: 1
backend:
  phases:
    build:
      commands:
        - npm install -g aws-cdk
        - cdk --version
        - |
          if [ -n "${AWS_BACKEND_ENVIRONMENT_ARN}" ]; then
            ENV="${AWS_BACKEND_ENVIRONMENT_ARN##*/}"
          elif [ -n "${USER_BRANCH}" ]; then
            ENV="${USER_BRANCH}"
          else 
            ENV="${AWS_BRANCH}"
          fi
          export ENV
          if [ "$REMOTE_BACKEND_EXISTS" = "false" ]; then
            amplify init --amplify "{\"envName\":\"${ENV}\",\"appId\":\"${AWS_APP_ID}\"}" --providers "{\"awscloudformation\":{\"configLevel\":\"project\",\"useProfile\":true,\"profileName\":\"default\"}}" --codegen "{\"generateCode\":false,\"generateDocs\":false}" --yes;
          else
            amplify pull --amplify "{\"envName\":\"${ENV}\",\"appId\":\"${AWS_APP_ID}\"}" --providers "{\"awscloudformation\":{\"configLevel\":\"project\",\"useProfile\":true,\"profileName\":\"default\"}}" --no-override --no-codegen --yes  && amplify init --amplify "{\"envName\":\"${ENV}\",\"appId\":\"${AWS_APP_ID}\"}" --providers "{\"awscloudformation\":{\"configLevel\":\"project\",\"useProfile\":true,\"profileName\":\"default\"}}" --codegen "{\"generateCode\":false,\"generateDocs\":false}" --yes;
          fi
        - amplify build
        - cd cdk
        - npm install
        - cdk synth
        - cd ..
        - cd out
        - diff ../cdk/cdk.out/CdkStack.template.json ../amplify/backend/custom/stubby/build/stubby-cloudformation-template.json | tee cdk-stack.diff
        - cd ..
        - amplify push || echo "oops, look at /out for debug"

frontend:
  phases:
    build:
      commands: []
  artifacts:
    # IMPORTANT - Please verify your build output directory
    baseDirectory: /out
    files:
      - '**/*'
  cache:
    paths: []
